/************************************************************************************************************************************
 *	neosmart STREAM - admin area
 *
 *	@copyright:			neosmart GmbH
 *	@licence:			https://neosmart-stream.de/legal/license-agreement/
 *	@documentation:		https://neosmart-stream.de/docs/
 *	@last update:		2013-10-22
 *	
 ************************************************************************************************************************************/
(function(a){a.fn.neosmartStreamAdmin=function(d){var r=a.extend({},a.fn.neosmartStreamAdmin.defaults,d);var h=this;var x={};r.pro=a("html").hasClass("pro");v();function v(){if(a('input[name="access_token_expires"]').length){a('input[name="access_token_expires"]').on("change focus keyup blur",p).trigger("keyup");setInterval(A,1000)}if(a(".nss-admin-add-channel").length){D()}l();if(a("#install-latest").length){z()}}function z(){a("#install-latest").click(m);x.updateRows=a(".nss-update-form .row");w(0)}function m(g){g.preventDefault();w(1);a.post("ajax-admin.php",{action:"download_latest"},function(o){if(o=="1"){n()}else{w(4)}})}function n(){w(2);a.post("ajax-admin.php",{action:"install_latest"},function(g){if(g=="success"){w(3);window.location.reload()}else{w(4)}})}function w(g){x.updateRows.hide().filter('[data-step="'+g+'"]').show()}function D(){a(".edit-channel").each(function(g,o){a(o).click(function(E){a(".nss-admin-channel").hide();a("#add-channel-error").hide();a(".channel-id-"+g).fadeIn()})});a(".nss-admin-remove").unbind("click").click(u);a(".nss-admin-remove-group").unbind("click").click(k);a(".nss-admin-add-channel").click(f);a(".save-channels").click(function(g){var o=a(this).attr("data-pos");y(false,o)});a(".atc-button").click(function(o){var g=a(o.currentTarget);j(g.attr("data-id"))});a(".atct-button").click(function(o){var g=a(o.currentTarget);b(g.attr("data-id"))});a("#new-channel-type").change(s);q();B()}function B(){a(".nss-edit-group,#nss-new-group").on("click",function(o){if(r.pro){a(".nss-channel-group").hide().filter('[data-id="'+a(o.currentTarget).attr("data-id")+'"]').fadeIn();a("#nss-new-group").hide()}else{a(".pro-warning").fadeIn()}});var g=a(".nss-channel-group").each(function(G,E){var K=a(E);var M=K.find('[name="group_name"]');var I=K.find(".select-group-channel");var H=K.find('[name="group_channel_list"]');var L=K.find(".nss-group-table");K.find(".nss-save-groups").each(function(O,P){a(P).on("click",function(Q){if(a.trim(M.val())==false){M.addClass("input-error").focus();return false}C()})});I.on("change",function(O){N();J()});J();function N(){var O=a.trim(I.val());var Q=I.find("option");var S=H.val().length?H.val().split(","):[];var P="";var R=false;Q.each(function(U,V){for(var T=0;T<S.length;T++){if(this.value&&S[T]==this.value){P+=","+this.value}if(S[T]==O){R=true}}});if(R===false){P+=","+O}P=F(P);H.val(P)}function o(S){var Q=a(S.currentTarget).text();var R=H.val().length?H.val().split(","):[];var P="";for(var O=0;O<R.length;O++){if(R[O]!=Q){P+=","+R[O]}}P=F(P);H.val(P);J()}function F(O){O=a.trim(O);if(O.substr(0,1)==","){O=O.substr(1)}if(O.substr(O.length-1)==","){O=O.substr(0,O.length-1)}return O}function J(){var R=H.val().length?H.val().split(","):[];var Q="";var P=I.find("option").show();for(var O=0;O<R.length;O++){Q+='<div class="nss-remove-group-channel">'+R[O]+"</div>";P.filter('option[value="'+R[O]+'"]').hide()}P.length-1==R.length?I.hide():I.show();L.html(Q);K.find(".nss-remove-group-channel").unbind("click").on("click",o)}})}function C(){var g='{"data":{';a(".nss-channel-group").each(function(E,G){var F=a(G);var H=a.trim(F.find('[name="group_channel_list"]').val());var o=a.trim(F.find('[name="group_name"]').val());o=o.toLowerCase().replace(/ /gi,"").substr(0,10);if(o.length){if(E>0){g+=","}g+='\n"'+o+'":';g+='"'+H+'"'}});g+="}}";a.ajax({url:"ajax-admin.php",data:"action=save_groups&json="+g,type:"post",complete:function(F){var E=F.responseText;if(E=="GROUPS_SAVED"){var o=document.location.href;o=o.substr(0,o.lastIndexOf("channels.php"))+"channels.php?saved=1";e(o)}}})}function e(g){document.location.href=g;a("body").addClass("nss-reload")}function l(){var o=a('[name="feedback_header_fb_send"]');var g=a('[name="feedback_header_fb_like"]');if(!o.length){return false}g.on("change",function(F){var E=g.filter(":checked").val();if(E=="0"){o.filter('[value="0"]').attr("checked",true)}});o.on("change",function(F){var E=o.filter(":checked").val();if(E=="1"){g.filter('[value="1"]').attr("checked",true)}})}function A(){a('input[name="access_token_expires"]:not(.nss-unknown-time)').trigger("keyup")}function q(){a(".nss-admin-channel").each(function(J,F){var M=a(F);var L=M.attr("data-channel");var E,o,H,K,G,I=1;M.find(".nss-admin-test").click(function(N){M.find(".channel-status").html("testing ...").addClass("loading");switch(L){case"facebook":E=M.find('input[name="id"]').val();H=M.find('input[name="access_token"]').val();I=M.find('input[name="limit"]').val();K=M.find('select[name="show_all"]').val();i("facebook",M,E,o,H,K,I,G);break;case"twitter":E=M.find('input[name="id"]').val();H=M.find('input[name="access_token"]').val();G=M.find('input[name="access_token_secret"]').val();I=M.find('input[name="limit"]').val();i("twitter",M,E,o,H,K,I,G);break;case"nss":o=M.find('input[name="url"]').val();i("nss",M,E,o,H,K,I,G);break}})});var g=a("#channels").attr("data-test");if(g=="auto"){a(".nss-admin-test").each(function(o,E){a(E).trigger("click")})}}function i(I,H,J,F,G,E,o,g){a.ajax({url:"ajax-test-channel.php",data:"channel="+I+"&id="+J+"&url="+F+"&token="+G+"&show_all="+E+"&limit="+o+"&secret="+g,type:"post",complete:function(L){var K=L.responseText;if(K=="success"){K='<span class="status active">active</span>'}H.find(".channel-status").html(K).removeClass("loading")}})}function s(){var g=a("#new-channel-type").val();a(".new-channel-container").hide();a("#add-channel-error").hide();a('.nss-admin-channel[data-channel!="new"]').hide();switch(g){case"facebook":a("#nss-admin-add-channel-facebook").fadeIn();break;case"twitter":a("#nss-admin-add-channel-twitter").fadeIn();break;case"nss":a("#nss-admin-add-channel-nss").fadeIn();break}}function p(F){var M=a(F.currentTarget);var L=parseInt(M.val())*1000;var G=new Date();var J=L-G.getTime();var o=J;var g="";var K=Math.floor(J/(60*60*24*1000));J-=K*(60*60*24*1000);var H=Math.floor(J/(60*60*1000));J-=H*(60*60*1000);var E=Math.floor(J/(60*1000));J-=E*(60*1000);var I=Math.floor(J/1000);if(K>1){g+=K+" days "}else{if(K==1){g+=K+" day "}}if(H>1){g+=H+" hours "}else{if(H==1){g+=H+" hour "}}if(E>1){g+=E+" minutes "}else{if(E==1){g+=E+" minute "}}if(I>1){g+=I+" seconds "}else{if(I==1){g+=I+" second "}}if(o<=0){g="Access token is expired"}if(parseInt(M.val())==0){M.addClass("nss-unknown-time");g='unknown - <a href="https://developers.facebook.com/tools/debug/access_token?q='+M.parent().find('[name="access_token"]').val()+'" target="_blank">Check<a/>'}M.parent().find(".expires_in_real_time").html(g)}function y(E,F){var o="";var g=E===true?".nss-admin-channel":'.nss-admin-channel:not([data-channel="new"])';a(g).each(function(N,J){var Q=a(J);var P=Q.attr("data-channel");var H,O,K,G,I,M;if(P=="new"){P=a("#new-channel-type").val();Q=a("#nss-admin-add-channel-"+P)}switch(P){case"facebook":H=a.trim(Q.find('input[name="id"]').val());O=a.trim(Q.find('input[name="access_token"]').val());K=parseInt(Q.find('input[name="limit"]').val());if(isNaN(K)){K=0}Q.find('input[name="limit"]').val(K);M=Q.find('[name="show_all"]').val();I=Q.find('[name="access_token_expires"]').val();if(!I||!O){I=0}o+="$nss->addChannel(array('type'=>'facebook','id'=>'"+H+"','access_token'=>'"+O+"','access_token_expires'=>'"+I+"','limit'=>"+K+",'show_all'=>"+M+"));\n";break;case"twitter":H=Q.find('input[name="id"]').val();O=a.trim(Q.find('input[name="access_token"]').val());access_token_secret=a.trim(Q.find('input[name="access_token_secret"]').val());K=parseInt(Q.find('input[name="limit"]').val());if(isNaN(K)||K<1){K=1}o+="$nss->addChannel(array('type'=>'twitter','id'=>'"+H+"','access_token'=>'"+O+"','access_token_secret'=>'"+access_token_secret+"','limit'=>"+K+"));\n";break;case"nss":G=Q.find('input[name="url"]').val();var L=G;if(L.substr(L.length-1)=="/"){L=L.substr(0,L.length-1)}H=L.substr(L.lastIndexOf("/")+1);H=H.replace(/[&\?\.#=]/gi,"-").substr(0,32);o+="$nss->addChannel(array('type'=>'nss','id'=>'"+H+"','url'=>'"+G+"'));\n";break}});a.ajax({url:"index.php",data:"action=update_channels&channels="+encodeURIComponent(o),type:"post",complete:function(H){var G=document.location.href;G=G.substr(0,G.lastIndexOf("channels.php"))+"channels.php?saved=1";target=F===false?"":"&pos="+F;e(G+target)}})}function u(o){var g=a(o.currentTarget).parent().parent();g.fadeOut(500,function(){g.remove();y(false)})}function k(o){var g=a(o.currentTarget).parent().parent();g.fadeOut(500,function(){g.remove();C()})}function c(o,g){a.ajax({url:"https://graph.facebook.com/"+o+"/feed/?access_token="+g,complete:function(E){}})}function f(){var G=a("#new-channel-type").val();var E=a("#add-channel-error").hide();var o=new Date();var F=G+"_"+Math.round(Math.random()*99999999)+"_"+o.getTime();var g="";var H;switch(G){case"facebook":H=a("#nss-admin-add-channel-facebook");if(H.find('input[name="id"]').val()==""){g+="<p>Enter Your Facebook ID</p>"}if(H.find('input[name="access_token"]').val()==""){g+="<p>Enter a valid Access Token</p>"}break;case"twitter":H=a("#nss-admin-add-channel-twitter");if(H.find('input[name="id"]').val()==""){g+="<p>Enter Your Twitter ID</p>"}break;case"nss":H=a("#nss-admin-add-channel-nss");if(H.find('input[name="url"]').val()==""){g+="<p>Enter Your NSS URL</p>"}break}if(g!=""){E.html('<div class="row">'+g+"</div>").fadeIn();return false}y(true,false)}function t(g){g?a(".not-saved").fadeIn(500):a(".not-saved").fadeOut(500)}function j(F){var o=window.open("atc.php","ATC","width=1000,height=500,left=100,top=100");var E=a(".channel-id-"+F);o.focus();var g=setInterval(function(){try{var G=o.$.find("#atc-access-token");var I=a(G);if(I.length){var J=o.$.find("#atc-expires");var H=a(J);E.find('input[name="access_token"]').val(I.text());E.find('input[name="access_token_expires"]').val(H.text()).trigger("change").parent().parent().fadeIn();o.close();clearInterval(g);t(true)}}catch(J){}},1000)}function b(F){var g=window.open("atct.php","ATCT","width=1000,height=500,left=100,top=100");var o=a(".channel-id-"+F);g.focus();var E=setInterval(function(){try{var G=g.$.find("#atct-token");var I=a(G);if(I.length){var J=g.$.find("#atct-secret");var H=a(J);o.find('input[name="access_token"]').val(I.text());o.find('input[name="access_token_secret"]').val(H.text()).trigger("change").parent().parent().fadeIn();g.close();clearInterval(E);t(true)}}catch(J){}},1000)}return h};a.fn.neosmartStreamAdmin.defaults={}})(jQuery);